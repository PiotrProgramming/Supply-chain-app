  <script>
    // Check if user is logged in
    document.addEventListener('DOMContentLoaded', () => {
      const user = localStorage.getItem('transforge_user');
      if (!user) {
        window.location.href = 'index.html';
        return;
      }
      
      const userData = JSON.parse(user);
      document.getElementById('userName').textContent = userData.email.split('@')[0];
      document.getElementById('companyName').textContent = userData.companyName;
      
      if (userData.isAdmin) {
        document.getElementById('adminMenuItem').style.display = 'block';
      }
      
      // Setup navigation
      setupNavigation();
      
      // Load initial page (dashboard by default)
      loadPage('dashboard');
    });

    // Helper functions for modal management
    function openModal(title, content) {
      document.getElementById('modalTitle').textContent = title;
      document.getElementById('modalBody').innerHTML = content;
      document.getElementById('modal').style.display = 'flex';
    }

    function closeModal() {
      document.getElementById('modal').style.display = 'none';
    }

    function setupNavigation() {
      // Add click listeners to all nav items
      document.querySelectorAll('.nav-item').forEach(item => {
        item.addEventListener('click', function() {
          // Remove active class from all items
          document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
          // Add active class to clicked item
          this.classList.add('active');
          // Load the page
          loadPage(this.dataset.page);
        });
      });
    }

    // Module file mapping
    const moduleFiles = {
      dashboard: { html: 'pages/dashboard.html', js: 'assets/js/dashboard.js' },
      drivers: { html: 'pages/drivers.html', js: 'assets/js/drivers.js' },
      tenders: { html: 'pages/tenders.html', js: 'assets/js/tenders.js' },
      invoices: { html: 'pages/invoices.html', js: 'assets/js/invoices.js' },
      reports: { html: 'pages/reports.html', js: 'assets/js/reports.js' },
      admin: { html: 'pages/admin.html', js: 'assets/js/admin.js' },
      chat: { html: 'pages/chat.html', js: 'assets/js/chat.js' },
      notifications: { html: 'pages/notifications.html', js: 'assets/js/notifications.js' }
    };

    function loadPage(pageName) {
      const pageContent = document.getElementById('pageContent');
      
      const titles = {
        dashboard: 'Dashboard',
        drivers: 'Drivers & Vehicles Management',
        tenders: 'Tenders',
        invoices: 'Invoices',
        reports: 'Reports',
        admin: 'Administration',
        chat: 'Chat',
        notifications: 'Notifications'
      };
      
      document.getElementById('pageTitle').textContent = titles[pageName] || 'Dashboard';
      
      if (pageName === 'dashboard') {
        // Load the default dashboard content which is already in the HTML
        // For simplicity, we just reload the existing content or a specific JS
        // to update the stats.
        pageContent.innerHTML = `
          <div class="dashboard-grid">
            <div class="card stat-card">
              <div class="stat-value" id="totalDrivers">0</div>
              <div class="stat-label">Total Drivers</div>
              <i class="fas fa-users stat-icon"></i>
            </div>
            <div class="card stat-card">
              <div class="stat-value" id="activeVehicles">0</div>
              <div class="stat-label">Active Vehicles</div>
              <i class="fas fa-truck stat-icon"></i>
            </div>
            <div class="card stat-card">
              <div class="stat-value" id="pendingTenders">0</div>
              <div class="stat-label">Pending Tenders</div>
              <i class="fas fa-file-contract stat-icon"></i>
            </div>
            <div class="card stat-card">
              <div class="stat-value" id="revenue">0</div>
              <div class="stat-label">Revenue</div>
              <i class="fas fa-dollar-sign stat-icon"></i>
            </div>
          </div>
        `;
        updateDashboardStats();
        return;
      }
      
      // Show loading indicator
      pageContent.innerHTML = '<div class="loading"></div>';

      const module = moduleFiles[pageName];
      if (module) {
        // Fetch and load the HTML file
        fetch(module.html)
          .then(response => {
            if (!response.ok) {
              throw new Error(`Failed to load ${module.html}`);
            }
            return response.text();
          })
          .then(html => {
            pageContent.innerHTML = html;
            
            // Now, load and execute the corresponding JavaScript file
            const oldScript = document.querySelector(`script[src="${module.js}"]`);
            if (oldScript) {
              oldScript.remove(); // Remove existing script to prevent re-execution issues
            }
            const script = document.createElement('script');
            script.src = module.js;
            document.body.appendChild(script);
          })
          .catch(error => {
            pageContent.innerHTML = `<div class="card"><h3 class="text-danger">Error Loading Page</h3><p>${error.message}</p></div>`;
          });
      } else {
        pageContent.innerHTML = `<div class="card"><h3 class="text-danger">Module Not Found</h3><p>The page for "${pageName}" could not be found. Please check your moduleFiles mapping.</p></div>`;
      }
    }
    
    // Function to update dashboard stats, used on initial load and by other modules
    function updateDashboardStats() {
      const drivers = JSON.parse(localStorage.getItem('transforge_drivers') || '[]');
      const vehicles = JSON.parse(localStorage.getItem('transforge_vehicles') || '[]');
      
      if (document.getElementById('totalDrivers')) {
        document.getElementById('totalDrivers').textContent = drivers.length;
      }
      if (document.getElementById('activeVehicles')) {
        document.getElementById('activeVehicles').textContent = vehicles.length;
      }
    }
  </script>
</body>
</html>
