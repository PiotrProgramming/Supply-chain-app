<!DOCTYPE html>
<html lang="en">
<head>
    <!-- ... existing head content ... -->
    <style>
        /* ... existing styles ... */
        
        /* Add loader animation */
        .view-loader {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
        }
        
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- ... existing body content ... -->

    <script>
        // ... existing appState and helper functions ...

        // Initialize the application
        function initApp() {
            const data = loadAppData();
            
            // Update app state
            appState.notifications = data.notifications;
            appState.chatMessages = data.chatMessages;
            appState.vehicles = data.vehicles;
            
            // Update notification badge
            updateNotificationBadge();
            
            // Render notifications
            renderNotifications();
            
            // Render chat messages
            renderChatMessages();
            
            // Check for expiring inspections
            checkExpiringInspections();
            
            // Setup event listeners for the app
            setupAppEventListeners();
            
            // Initialize views
            initView();
        }
        
        // Setup event listeners after login
        function setupAppEventListeners() {
            // Set up navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', function() {
                    const target = this.getAttribute('data-target');
                    loadView(target);
                });
            });
            
            // Initialize file uploads
            document.getElementById('tender-upload-area').addEventListener('click', function() {
                document.getElementById('tender-file').click();
            });
            
            document.getElementById('invoice-upload-area').addEventListener('click', function() {
                document.getElementById('invoice-file').click();
            });
            
            // Notification and chat icons
            document.getElementById('notification-icon').addEventListener('click', toggleNotificationPanel);
            document.getElementById('chat-icon').addEventListener('click', toggleChatPanel);
            
            // Chat send button
            document.getElementById('chat-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
        }
        
        // Initialize views after login
        function initView() {
            loadView(appState.currentView);
        }

        // View Management System
        function loadView(viewName) {
            appState.currentView = viewName;
            
            // Show loading indicator
            const mainContent = document.getElementById('main-content');
            mainContent.innerHTML = '<div class="view-loader"><div class="loader"></div></div>';
            
            // Load view after short delay
            setTimeout(() => {
                switch(viewName) {
                    case 'dashboard':
                        loadDashboardView();
                        break;
                    case 'drivers':
                        loadDriversView();
                        break;
                    case 'tenders':
                        loadTendersView();
                        break;
                    case 'payments':
                        loadPaymentsView();
                        break;
                    case 'reports':
                        loadReportsView();
                        break;
                    case 'admin':
                        loadAdminView();
                        break;
                }
                
                // Update active navigation item
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.remove('active');
                    if (item.getAttribute('data-target') === viewName) {
                        item.classList.add('active');
                    }
                });
            }, 300);
        }
        
        function loadDashboardView() {
            const { tenders, drivers, payments, vehicles } = loadAppData();
            
            const content = `
                <div class="dashboard-header">
                    <h1>Dashboard</h1>
                    <div>${new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</div>
                </div>
                
                <div class="stats-container">
                    <div class="stat-card">
                        <i class="fas fa-truck-loading icon"></i>
                        <h3>Active Tenders</h3>
                        <div class="value">${tenders.filter(t => t.status !== 'delivered' && t.status !== 'cancelled').length}</div>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-users icon"></i>
                        <h3>Total Drivers</h3>
                        <div class="value">${drivers.filter(d => d.status === 'active').length}</div>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-exclamation-triangle icon"></i>
                        <h3>Pending Payments</h3>
                        <div class="value">${payments.filter(p => p.status === 'pending').length}</div>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-euro-sign icon"></i>
                        <h3>Monthly Revenue</h3>
                        <div class="value">€${payments
                            .filter(p => new Date(p.issueDate) >= new Date(Date.now() - 30*24*60*60*1000) && p.status === 'paid')
                            .reduce((sum, p) => sum + p.amount, 0)
                            .toFixed(2)}</div>
                    </div>
                </div>
                
                <div class="section">
                    <div class="section-header">
                        <h2>Recent Tenders</h2>
                        <button class="btn btn-primary" onclick="openModal('tender-modal')">
                            <i class="fas fa-plus"></i> New Tender
                        </button>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Route</th>
                                <th>Driver</th>
                                <th>Load %</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${tenders.slice(0, 5).map(tender => `
                                <tr>
                                    <td>#${tender.id}</td>
                                    <td>${tender.origin} to ${tender.destination}</td>
                                    <td>${tender.driver || 'Unassigned'}</td>
                                    <td>${tender.loadPercentage}%</td>
                                    <td><span class="status-badge status-${tender.status.replace(' ', '_')}">
                                        ${tender.status.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase())}
                                    </span></td>
                                    <td>
                                        <button class="btn btn-primary" style="padding: 5px 10px;" onclick="viewTender(${tender.id})">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                
                <div class="section">
                    <div class="section-header">
                        <h2>Upcoming Inspections</h2>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Vehicle</th>
                                <th>Type</th>
                                <th>Inspection Due</th>
                                <th>OC Due</th>
                                <th>Driver</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${vehicles.slice(0, 5).map(vehicle => {
                                const driver = drivers.find(d => d.id === vehicle.driverId);
                                const today = new Date();
                                const inspectionDate = new Date(vehicle.inspectionExpiry);
                                const ocDate = new Date(vehicle.ocExpiry);
                                const inspectionDiff = Math.ceil((inspectionDate - today) / (1000 * 60 * 60 * 24));
                                const ocDiff = Math.ceil((ocDate - today) / (1000 * 60 * 60 * 24));
                                
                                let inspectionStatus = 'safe';
                                if (inspectionDiff <= 0) inspectionStatus = 'expired';
                                else if (inspectionDiff <= 14) inspectionStatus = 'warning';
                                
                                let ocStatus = 'safe';
                                if (ocDiff <= 0) ocStatus = 'expired';
                                else if (ocDiff <= 14) ocStatus = 'warning';
                                
                                return `
                                    <tr>
                                        <td>${vehicle.regNumber}</td>
                                        <td>${vehicle.type}</td>
                                        <td>
                                            <span class="status-badge ${inspectionStatus === 'expired' ? 'status-overdue' : inspectionStatus === 'warning' ? 'status-pending' : 'status-delivered'}">
                                                ${inspectionDate.toLocaleDateString()} (${inspectionDiff} days)
                                            </span>
                                        </td>
                                        <td>
                                            <span class="status-badge ${ocStatus === 'expired' ? 'status-overdue' : ocStatus === 'warning' ? 'status-pending' : 'status-delivered'}">
                                                ${ocDate.toLocaleDateString()} (${ocDiff} days)
                                            </span>
                                        </td>
                                        <td>${driver ? driver.firstName + ' ' + driver.lastName : 'Unassigned'}</td>
                                        <td>
                                            <button class="btn btn-warning btn-sm" onclick="editVehicle(${vehicle.id})">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            document.getElementById('main-content').innerHTML = content;
        }
        
        // Implement missing view functions
        function loadDriversView() {
            const { drivers } = loadAppData();
            
            const content = `
                <div class="dashboard-header">
                    <h1>Driver Management</h1>
                    <button class="btn btn-primary" onclick="openModal('driver-modal')">
                        <i class="fas fa-plus"></i> Add Driver
                    </button>
                </div>
                
                <div class="section">
                    <table>
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Contact</th>
                                <th>License</th>
                                <th>Status</th>
                                <th>Vehicle</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${drivers.map(driver => `
                                <tr>
                                    <td>${driver.firstName} ${driver.lastName}</td>
                                    <td>${driver.contact}</td>
                                    <td>${driver.license}</td>
                                    <td><span class="status-badge ${driver.status === 'active' ? 'status-delivered' : 'status-cancelled'}">
                                        ${driver.status.toUpperCase()}
                                    </span></td>
                                    <td>${driver.truck || 'N/A'}</td>
                                    <td>
                                        <button class="btn btn-primary btn-sm" onclick="editDriver(${driver.id})">
                                            <i class="fas fa-edit"></i> Edit
                                        </button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            document.getElementById('main-content').innerHTML = content;
        }
        
        function loadTendersView() {
            const { tenders } = loadAppData();
            
            const content = `
                <div class="dashboard-header">
                    <h1>Tender Management</h1>
                    <button class="btn btn-primary" onclick="openModal('tender-modal')">
                        <i class="fas fa-plus"></i> New Tender
                    </button>
                </div>
                
                <div class="section">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Route</th>
                                <th>Driver</th>
                                <th>Load Size</th>
                                <th>Cargo</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${tenders.map(tender => `
                                <tr>
                                    <td>#${tender.id}</td>
                                    <td>${tender.origin} → ${tender.destination}</td>
                                    <td>${tender.driver || 'Unassigned'}</td>
                                    <td>${tender.loadSize} sqm</td>
                                    <td>${tender.cargo}</td>
                                    <td><span class="status-badge status-${tender.status.replace(' ', '_')}">
                                        ${tender.status.replace('_', ' ').toUpperCase()}
                                    </span></td>
                                    <td>
                                        <button class="btn btn-primary btn-sm" onclick="viewTender(${tender.id})">
                                            <i class="fas fa-eye"></i> View
                                        </button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            document.getElementById('main-content').innerHTML = content;
        }
        
        function loadPaymentsView() {
            const { payments } = loadAppData();
            
            const content = `
                <div class="dashboard-header">
                    <h1>Payment Management</h1>
                    <button class="btn btn-primary" onclick="openModal('payment-modal')">
                        <i class="fas fa-plus"></i> Add Payment
                    </button>
                </div>
                
                <div class="section">
                    <table>
                        <thead>
                            <tr>
                                <th>Invoice #</th>
                                <th>Tender ID</th>
                                <th>Amount</th>
                                <th>Issue Date</th>
                                <th>Due Date</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${payments.map(payment => {
                                const dueDate = new Date(payment.issueDate);
                                dueDate.setDate(dueDate.getDate() + payment.dueDays);
                                
                                return `
                                <tr>
                                    <td>${payment.invoiceNumber}</td>
                                    <td>#${payment.tenderId}</td>
                                    <td>${payment.currency}${payment.amount.toFixed(2)}</td>
                                    <td>${new Date(payment.issueDate).toLocaleDateString()}</td>
                                    <td>${dueDate.toLocaleDateString()}</td>
                                    <td><span class="status-badge ${payment.status === 'paid' ? 'status-paid' : 'status-pending'}">
                                        ${payment.status.toUpperCase()}
                                    </span></td>
                                    <td>
                                        <button class="btn btn-primary btn-sm">
                                            <i class="fas fa-edit"></i> Edit
                                        </button>
                                    </td>
                                </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            document.getElementById('main-content').innerHTML = content;
        }
        
        function loadReportsView() {
            const content = `
                <div class="dashboard-header">
                    <h1>Reports</h1>
                </div>
                
                <div class="section">
                    <div class="section-header">
                        <h2>Financial Reports</h2>
                        <div>
                            <button class="btn btn-primary" onclick="generatePDFReport('financial')">
                                <i class="fas fa-file-pdf"></i> Export PDF
                            </button>
                        </div>
                    </div>
                    
                    <div class="chart-container">
                        <canvas id="finance-chart"></canvas>
                    </div>
                </div>
                
                <div class="section">
                    <div class="section-header">
                        <h2>Performance Reports</h2>
                        <div>
                            <button class="btn btn-primary" onclick="generatePDFReport('performance')">
                                <i class="fas fa-file-pdf"></i> Export PDF
                            </button>
                        </div>
                    </div>
                    
                    <div class="chart-container">
                        <canvas id="performance-chart"></canvas>
                    </div>
                </div>
            `;
            
            document.getElementById('main-content').innerHTML = content;
            
            // Initialize charts
            setTimeout(() => {
                renderFinanceChart();
                renderPerformanceChart();
            }, 500);
        }
        
        function loadAdminView() {
            const { users } = loadAppData();
            
            const content = `
                <div class="dashboard-header">
                    <h1>Administration</h1>
                    <button class="btn btn-primary" onclick="openModal('user-modal')">
                        <i class="fas fa-plus"></i> Manage Users
                    </button>
                </div>
                
                <div class="section">
                    <div class="section-header">
                        <h2>GitHub Sync</h2>
                    </div>
                    <div class="github-sync">
                        <div class="form-group">
                            <label>Repository URL</label>
                            <input type="text" id="github-repo" class="form-control" placeholder="https://github.com/username/repo">
                        </div>
                        <div class="form-group">
                            <label>Access Token</label>
                            <input type="password" id="github-token" class="form-control" placeholder="GitHub personal access token">
                        </div>
                        <div class="form-group">
                            <label>Data File Path</label>
                            <input type="text" id="github-path" class="form-control" value="transport-data.json">
                        </div>
                        <div class="form-group">
                            <label>Current Data</label>
                            <textarea id="github-data" class="form-control" rows="5" readonly>${JSON.stringify(loadAppData(), null, 2)}</textarea>
                        </div>
                        <button class="btn btn-primary" onclick="syncWithGitHub()">
                            <i class="fas fa-sync"></i> Sync with GitHub
                        </button>
                        <div id="sync-status" class="sync-status sync-pending">Sync not started</div>
                    </div>
                </div>
            `;
            
            document.getElementById('main-content').innerHTML = content;
        }
        
        // Implement missing functions
        function renderFinanceChart() {
            const ctx = document.getElementById('finance-chart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                    datasets: [{
                        label: 'Revenue',
                        data: [12000, 19000, 15000, 18000, 22000, 24000],
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
        
        function renderPerformanceChart() {
            const ctx = document.getElementById('performance-chart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['John Smith', 'Emma Johnson', 'Michael Brown', 'Sarah Davis'],
                    datasets: [{
                        label: 'Completed Tenders',
                        data: [12, 8, 10, 7],
                        backgroundColor: '#27ae60'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
        
        function generatePDFReport(type) {
            alert(`Generating ${type} report...`);
            // Actual PDF generation would go here
        }
        
        function viewTender(id) {
            const { tenders } = loadAppData();
            const tender = tenders.find(t => t.id === id);
            
            if (tender) {
                const content = `
                    <h3>Tender #${tender.id}</h3>
                    <div class="vehicle-info">
                        <div class="vehicle-row">
                            <div class="vehicle-label">Origin:</div>
                            <div>${tender.origin}</div>
                        </div>
                        <div class="vehicle-row">
                            <div class="vehicle-label">Destination:</div>
                            <div>${tender.destination}</div>
                        </div>
                        <div class="vehicle-row">
                            <div class="vehicle-label">Driver:</div>
                            <div>${tender.driver || 'Not assigned'}</div>
                        </div>
                        <div class="vehicle-row">
                            <div class="vehicle-label">Load Size:</div>
                            <div>${tender.loadSize} sqm</div>
                        </div>
                        <div class="vehicle-row">
                            <div class="vehicle-label">Cargo:</div>
                            <div>${tender.cargo}</div>
                        </div>
                        <div class="vehicle-row">
                            <div class="vehicle-label">Status:</div>
                            <div><span class="status-badge status-${tender.status.replace(' ', '_')}">
                                ${tender.status.toUpperCase()}
                            </span></div>
                        </div>
                    </div>
                `;
                
                document.getElementById('details-tab').innerHTML = content;
                document.getElementById('tender-id').value = tender.id;
                document.getElementById('issue-tender-id').value = tender.id;
                openModal('view-tender-modal');
            }
        }
        
        function editDriver(id) {
            const { drivers } = loadAppData();
            const driver = drivers.find(d => d.id === id);
            
            if (driver) {
                document.getElementById('first_name').value = driver.firstName;
                document.getElementById('last_name').value = driver.lastName;
                document.getElementById('contact').value = driver.contact;
                document.getElementById('license').value = driver.license;
                document.getElementById('truck_number').value = driver.truck || '';
                document.getElementById('trailer_number').value = driver.trailer || '';
                document.getElementById('status').value = driver.status;
                
                // Clear existing fuel card entries
                document.getElementById('fuel-cards-container').innerHTML = '';
                
                // Add fuel cards
                driver.fuelCards.forEach(card => {
                    addFuelCardField(card);
                });
                
                openModal('driver-modal');
            }
        }
        
        function editVehicle(id) {
            const { vehicles } = loadAppData();
            const vehicle = vehicles.find(v => v.id === id);
            
            if (vehicle) {
                document.getElementById('vehicle-type').value = vehicle.type;
                document.getElementById('vehicle-reg').value = vehicle.regNumber;
                document.getElementById('oc-expiry').value = vehicle.ocExpiry;
                document.getElementById('inspection-expiry').value = vehicle.inspectionExpiry;
                document.getElementById('alert-days').value = vehicle.alertDays;
                openModal('vehicle-modal');
            }
        }
        
        function addFuelCardField(card = {}) {
            const container = document.getElementById('fuel-cards-container');
            const newEntry = document.createElement('div');
            newEntry.className = 'fuel-card-entry';
            newEntry.innerHTML = `
                <div class="form-group">
                    <label>Card Number</label>
                    <input type="text" name="card_number[]" value="${card.number || ''}" placeholder="e.g., 1234 5678 9012 3456">
                </div>
                <div class="form-group">
                    <label>PIN</label>
                    <input type="text" name="card_pin[]" value="${card.pin || ''}" placeholder="e.g., 1234">
                </div>
                <div class="form-group">
                    <label>Expiry Date</label>
                    <input type="date" name="card_expiry[]" value="${card.expiry || ''}">
                </div>
                <div class="form-group">
                    <label>No Expiry Date</label>
                    <input type="checkbox" name="card_no_expiry[]" ${card.noExpiry ? 'checked' : ''}>
                </div>
            `;
            container.appendChild(newEntry);
        }
        
        // Chat functions
        function toggleNotificationPanel() {
            const panel = document.getElementById('notification-panel');
            panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
        }
        
        function closeNotificationPanel() {
            document.getElementById('notification-panel').style.display = 'none';
        }
        
        function renderNotifications() {
            const container = document.getElementById('notification-list');
            if (!container) return;
            
            container.innerHTML = appState.notifications.map(notification => `
                <div class="notification-item ${notification.read ? '' : 'unread'}" onclick="markNotificationRead(${notification.id})">
                    <div class="notification-title">
                        <i class="fas fa-${notification.type === 'warning' ? 'exclamation-triangle' : 'info-circle'}"></i>
                        ${notification.title}
                    </div>
                    <div class="notification-message">${notification.message}</div>
                    <div class="notification-time">${new Date(notification.timestamp).toLocaleString()}</div>
                </div>
            `).join('');
        }
        
        function updateNotificationBadge() {
            const unread = appState.notifications.filter(n => !n.read).length;
            const badge = document.getElementById('notification-count');
            if (badge) badge.textContent = unread;
        }
        
        function toggleChatPanel() {
            const panel = document.getElementById('chat-panel');
            if (panel) {
                panel.style.display = panel.style.display === 'flex' ? 'none' : 'flex';
                // Scroll to bottom when opening
                if (panel.style.display === 'flex') {
                    const messages = document.getElementById('chat-messages');
                    messages.scrollTop = messages.scrollHeight;
                }
            }
        }
        
        function closeChatPanel() {
            const panel = document.getElementById('chat-panel');
            if (panel) panel.style.display = 'none';
        }
        
        function renderChatMessages() {
            const container = document.getElementById('chat-messages');
            if (!container) return;
            
            container.innerHTML = appState.chatMessages.map(msg => `
                <div class="message ${msg.sender === appState.currentUser.name ? 'sent' : 'received'}">
                    <div class="message-sender">${msg.sender}</div>
                    <div class="message-text">${msg.message}</div>
                    <div class="message-time">${new Date(msg.timestamp).toLocaleTimeString()}</div>
                </div>
            `).join('');
            
            // Scroll to bottom
            container.scrollTop = container.scrollHeight;
        }
        
        function sendMessage() {
            const input = document.getElementById('chat-input');
            if (!input) return;
            
            const message = input.value.trim();
            if (message && appState.currentUser) {
                appState.chatMessages.push({
                    id: Date.now(),
                    sender: appState.currentUser.name,
                    message: message,
                    timestamp: new Date().toISOString()
                });
                
                // Save to localStorage
                saveAppData({
                    ...loadAppData(),
                    chatMessages: appState.chatMessages
                });
                
                // Update UI
                renderChatMessages();
                input.value = '';
            }
        }

        // Login function
        function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            const { users } = loadAppData();
            const user = users.find(u => u.username === username && u.password === password);
            
            if (user) {
                appState.currentUser = user;
                
                document.getElementById('auth-screen').style.display = 'none';
                document.getElementById('app-container').style.display = 'block';
                document.getElementById('current-user').textContent = user.name;
                document.getElementById('current-role').textContent = user.role.charAt(0).toUpperCase() + user.role.slice(1);
                
                // Initialize the app after login
                initApp();
            } else {
                alert('Invalid credentials. Please try again.');
            }
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Add chat icon ID if missing
            if (!document.getElementById('chat-icon')) {
                const chatIcon = document.querySelector('.chat-icon');
                if (chatIcon) chatIcon.id = 'chat-icon';
            }
            
            // Initialize demo data if needed
            if (!localStorage.getItem('transport_users')) {
                initDemoData();
            }
            
            // Add login button event listener
            const loginBtn = document.querySelector('.btn.btn-primary.btn-block');
            if (loginBtn) {
                loginBtn.addEventListener('click', login);
            }
        });
    </script>
</body>
</html>
