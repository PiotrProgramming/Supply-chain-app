<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TransForge™ - GitHub Setup</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="assets/css/main.css">
  <style>
    .alert {
      padding: 12px 20px;
      border-radius: 4px;
      margin: 15px 0;
      font-weight: 500;
    }
    .alert-info {
      background-color: #e3f2fd;
      color: #1976d2;
      border-left: 4px solid #1976d2;
    }
    .alert-success {
      background-color: #e8f5e9;
      color: #388e3c;
      border-left: 4px solid #388e3c;
    }
    .alert-warning {
      background-color: #fff8e1;
      color: #f57f17;
      border-left: 4px solid #f57f17;
    }
    .alert-danger {
      background-color: #ffebee;
      color: #d32f2f;
      border-left: 4px solid #d32f2f;
    }
    .github-step {
      display: flex;
      margin-bottom: 1.5rem;
      padding: 1rem;
      border-radius: 8px;
      background-color: #f8f9fa;
    }
    .step-number {
      background: #4361ee;
      color: white;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      margin-right: 15px;
      flex-shrink: 0;
    }
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    .btn i {
      margin-right: 0;
    }
    .mt-3 {
      margin-top: 1.5rem;
    }
  </style>
</head>
<body>
  <div class="login-container">
    <div class="login-left">
      <div class="login-hero">
        <h1>Connect to GitHub</h1>
        <p>Securely store your company data in a private repository</p>
        <div class="github-icon">
          <i class="fab fa-github fa-5x"></i>
        </div>
      </div>
    </div>
    <div class="login-right">
      <div class="github-setup">
        <h2><i class="fab fa-github"></i> GitHub Setup</h2>
        <div class="github-steps">
          <div class="github-step">
            <div class="step-number">1</div>
            <div>
              <h3>Create GitHub Account</h3>
              <p><a href="https://github.com/join" target="_blank">Sign up for GitHub</a> if you don't have an account</p>
            </div>
          </div>
          <div class="github-step">
            <div class="step-number">2</div>
            <div>
              <h3>Generate Access Token</h3>
              <p>Go to <strong>Settings → Developer Settings → Personal Access Tokens → Generate New Token</strong></p>
              <p>Select <code>repo</code> permissions and enable <code>admin:repo_hook</code></p>
              <button class="btn btn-secondary" id="tokenGuideBtn">
                <i class="fas fa-book"></i> Token Creation Guide
              </button>
            </div>
          <div class="github-step">
            <div class="step-number">3</div>
            <div>
              <h3>Repository Configuration</h3>
              <div class="form-group">
                <label>GitHub Personal Access Token</label>
                <input type="password" id="githubToken" placeholder="Paste token here" autocomplete="off" required>
              </div>
              <div class="form-group">
                <label>Repository Name</label>
                <input type="text" id="repoName" placeholder="transforge-company-data" value="transforge-company-data" required>
                <small>Will be created as private repository</small>
              </div>
        
        <button id="validateTokenBtn" class="btn btn-info mb-2">
          <i class="fas fa-check-circle"></i> Validate Token First
        </button>
        
        <button id="setupGitHubBtn" class="btn btn-primary">
          <i class="fas fa-cloud-upload-alt"></i> Create Repository & Initialize
        </button>
        
        <div id="setupStatus" class="mt-3"></div>
        
        <p style="text-align:center;margin-top:1.5rem;">
          <a href="#" id="skipForNow">Skip GitHub for now (use local storage)</a>
        </p>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const statusDiv = document.getElementById('setupStatus');
      
      // Token guide
      document.getElementById('tokenGuideBtn').addEventListener('click', () => {
        alert('1. Go to: github.com/settings/tokens\n\n' +
              '2. Click "Generate new token" (classic)\n\n' +
              '3. Name: "TransForge Access"\n\n' +
              '4. Select these scopes:\n' +
              '   - repo (full control)\n' +
              '   - admin:repo_hook (manage hooks)\n\n' +
              '5. Click "Generate token" and COPY immediately');
      });

      // Token validation
      document.getElementById('validateTokenBtn').addEventListener('click', async () => {
        const token = document.getElementById('githubToken').value.trim();
        if (!token) {
          statusDiv.innerHTML = '<div class="alert alert-danger">Please enter a token first</div>';
          return;
        }

        statusDiv.innerHTML = '<div class="alert alert-info">Validating token...</div>';
        try {
          const userRes = await fetch('https://api.github.com/user', {
            headers: { Authorization: `token ${token}` }
          });

          if (!userRes.ok) {
            const error = await userRes.json();
            throw new Error(`Invalid token: ${error.message || 'Authentication failed'}`);
          }

          const user = await userRes.json();
          statusDiv.innerHTML = `
            <div class="alert alert-success">
              ✅ Token valid!<br>
              User: ${user.login}<br>
              ${user.name ? `Name: ${user.name}<br>` : ''}
              ${user.email ? `Email: ${user.email}` : ''}
            </div>
          `;
          
          // Check repo permissions
          statusDiv.innerHTML += '<div class="alert alert-info">Checking repository permissions...</div>';
          const scopesRes = await fetch('https://api.github.com/ user/installations', {
            headers: { Authorization: `token ${token}` }
          });
          
          if (!scopesRes.ok) {
            statusDiv.innerHTML += `<div class="alert alert-warning">⚠️ Could not verify full permissions. Trying repository creation anyway.</div>`;
          } else {
            const scopes = scopesRes.headers.get('X-OAuth-Scopes')?.split(', ');
            if (!scopes.includes('repo') || !scopes.includes('admin:repo_hook')) {
              statusDiv.innerHTML += `
                <div class="alert alert-warning">
                  ⚠️ Missing required permissions:<br>
                  - repo (full control)<br>
                  - admin:repo_hook<br>
                  Repository creation might fail!
                </div>
              `;
            }
          }
          
        } catch (err) {
          console.error('Validation error:', err);
          statusDiv.innerHTML = `<div class="alert alert-danger">${err.message}</div>`;
        }
      });

      // GitHub setup
      document.getElementById('setupGitHubBtn').addEventListener('click', async () => {
        const token = document.getElementById('githubToken').value.trim();
        const repo = document.getElementById('repoName').value.trim();
        const btn = document.getElementById('setupGitHubBtn');
        const statusDiv = document.getElementById('setupStatus');

        if (!token || !repo) {
          statusDiv.innerHTML = '<div class="alert alert-danger">Please fill in all fields</div>';
          return;
        }

        // Reset UI
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating Repository...';
        statusDiv.innerHTML = '';

        try {
          // 1. Get user info
          statusDiv.innerHTML += '<div class="alert alert-info">Verifying GitHub identity...</div>';
          const userRes = await fetch('https://api.github.com/user', {
            headers: { Authorization: `token ${token}` }
          });
          
          if (!userRes.ok) {
            const error = await userRes.json();
            throw new Error(`Authentication failed: ${error.message || 'Invalid token'}`);
          }
          
          const user = await userRes.json();
          const owner = user.login;

          // 2. Validate repository name
          statusDiv.innerHTML += '<div class="alert alert-info">Validating repository name...</div>';
          if (!/^[a-z0-9](?:[a-z0-9]|-(?=[a-z0-9])){0,98}[a-z0-9]$/.test(repo)) {
            throw new Error('Repository name must be lowercase, 1-100 characters, with only letters, numbers, and hyphens');
          }

          // 3. Check if repo exists
          statusDiv.innerHTML += '<div class="alert alert-info">Checking repository existence...</div>';
          const repoCheckRes = await fetch(`https://api.github.com/repos/${owner}/${repo}`, {
            headers: { Authorization: `token ${token}` }
          });

          if (repoCheckRes.ok) {
            throw new Error(`Repository already exists: https://github.com/${owner}/${repo}`);
          }

          // 4. Create repository
          statusDiv.innerHTML += '<div class="alert alert-info">Creating new repository...</div>';
          const createRes = await fetch('https://api.github.com/user/repos', {
            method: 'POST',
            headers: {
              Authorization: `token ${token}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              name: repo,
              private: true,
              auto_init: false,  // We'll create files manually
              has_issues: false,
              has_projects: false,
              has_wiki: false
            })
          });

          if (!createRes.ok) {
            const error = await createRes.json();
            throw new Error(`Repository creation failed: ${error.message || 'GitHub API error'}`);
          }

          // 5. Create data directory
          statusDiv.innerHTML += '<div class="alert alert-info">Creating data directory...</div>';
          await createGitHubDirectory(owner, repo, token);

          // 6. Create data files
          statusDiv.innerHTML += '<div class="alert alert-info">Initializing data files...</div>';
          const files = [
            'users.json', 'drivers.json', 'vehicles.json', 'tenders.json',
            'invoices.json', 'reports.json', 'chat.json', 'notifications.json'
          ];

          for (const file of files) {
            try {
              await createGitHubFile(owner, repo, token, `data/${file}`, []);
            } catch (err) {
              console.warn(`File creation warning: ${file} - ${err.message}`);
              statusDiv.innerHTML += `<div class="alert alert-warning">⚠️ ${file} initialization skipped: ${err.message}</div>`;
            }
          }

          // 7. Save credentials
          localStorage.setItem('githubToken', token);
          localStorage.setItem('githubRepo', repo);
          
          // 8. Create admin user
          statusDiv.innerHTML += '<div class="alert alert-info">Creating admin user...</div>';
          const pendingUser = JSON.parse(localStorage.getItem('pendingUser'));
          pendingUser.isAdmin = true;
          
          const users = await getGitHubFile(owner, repo, token, 'data/users.json');
          users.push(pendingUser);
          await createGitHubFile(owner, repo, token, 'data/users.json', users);

          // Success
          statusDiv.innerHTML += '<div class="alert alert-success">✅ Setup complete! Redirecting to dashboard...</div>';
          setTimeout(() => window.location.href = 'dashboard.html', 2000);

        } catch (err) {
          console.error('Setup failed:', err);
          statusDiv.innerHTML += `<div class="alert alert-danger">❌ ${err.message}</div>`;
          btn.disabled = false;
          btn.innerHTML = '<i class="fas fa-cloud-upload-alt"></i> Try Again';
        }
      });

      // Skip to local storage
      document.getElementById('skipForNow').addEventListener('click', (e) => {
        e.preventDefault();
        try {
          const pendingUser = JSON.parse(localStorage.getItem('pendingUser'));
          pendingUser.isAdmin = true;
          pendingUser.localOnly = true;

          // Use local storage
          const users = JSON.parse(localStorage.getItem('transforge_data_users') || '[]');
          users.push(pendingUser);
          localStorage.setItem('transforge_data_users', JSON.stringify(users));
          localStorage.setItem('transforge_user', JSON.stringify(pendingUser));
          localStorage.removeItem('pendingUser');
          
          // Redirect to dashboard
          window.location.href = 'dashboard.html';
        } catch (err) {
          console.error('Local setup failed:', err);
          statusDiv.innerHTML += `<div class="alert alert-danger">❌ Local setup failed: ${err.message}</div>`;
        }
      });

      // GitHub API helpers
      async function getGitHubFile(owner, repo, token, path) {
        const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`, {
          headers: { Authorization: `token ${token}` }
        });
        
        if (res.status === 404) return [];
        if (!res.ok) throw new Error(`File read error: ${res.status} ${res.statusText}`);
        
        const data = await res.json();
        return JSON.parse(atob(data.content));
      }

      async function createGitHubFile(owner, repo, token, path, content) {
        let sha = null;
        
        // Check if file exists
        try {
          const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`, {
            headers: { Authorization: `token ${token}` }
          });
          
          if (res.ok) {
            const data = await res.json();
            sha = data.sha;
          }
        } catch (err) {
          // File doesn't exist
        }
        
        const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`, {
          method: 'PUT',
          headers: {
            Authorization: `token ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            message: `Initialize ${path}`,
            content: btoa(JSON.stringify(content, null, 2)),
            sha: sha
          })
        });
        
        if (!res.ok) {
          const error = await res.json();
          throw new Error(`File creation failed: ${error.message || res.statusText}`);
        }
      }

      async function createGitHubDirectory(owner, repo, token) {
        // GitHub doesn't have a direct directory API, so create a placeholder file
        await createGitHubFile(owner, repo, token, 'data/.gitkeep', '');
      }
    });
  </script>
</body>
</html>
